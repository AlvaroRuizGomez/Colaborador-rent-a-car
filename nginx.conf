# https://github.com/vegasbrianc/docker-compose-demo/blob/master/docker-compose.yml
# http://anandmanisankar.com/posts/docker-container-nginx-node-redis-example/
# https://github.com/UsamaAshraf/scaling-out-docker-nginx/blob/master/load-balancer/nginx.conf
# https://engineering.tines.com/blog/simple-zero-downtime-deploys

# https://gist.github.com/saniaky/dc75cbf64922e418400b0f54ed5b2c3a

# https://github.com/nginx-proxy/acme-companion


upstream frontend_group {
    least_conn;
    server frontend_1:8080 max_fails=3 fail_timeout=30s;
    # server frontend_2:8080 max_fails=3 fail_timeout=30s;
}

upstream backoffice_group {
    # least_conn;
    server backoffice_1:3100 max_fails=10 fail_timeout=30s;
}

upstream frontend_basico_group {
    # least_conn;
    # server frontend_basico_1 max_fails=10 fail_timeout=30s;
    server frontend_basico_1:443 max_fails=10 fail_timeout=30s;
}

proxy_cache_path /opt/bitnami/nginx/cache use_temp_path=off levels=1:2 keys_zone=cache_zone:100m max_size=100m inactive=1d;

server
{
    server_name "rencarmallorca_es" ;

    listen 80 ssl;
    listen 443 ssl default_server;

    # certificado
    # ssl_certificate      bitnami/certs/server_local.crt;
    # ssl_certificate_key  bitnami/certs/server_local.key;
    ssl_certificate      bitnami/certs/server.crt;
    ssl_certificate_key  bitnami/certs/server.key;
    ssl_trusted_certificate bitnami/certs/chain.pem;
    # ssl_session_cache    shared:SSL:1m;
    ssl_session_timeout  5m;
    ssl_session_cache builtin:1000 shared:SSL:10m;

    

    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    # ssl_ciphers HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4; 
    ssl_ciphers  HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers  on;

    gzip on;
    gzip_types text/plain text/css application/javascript application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

    # server_name rentcarmallorca_es;
    access_log /opt/bitnami/nginx/logs/rentcamallorca_es_access.log;
    error_log /opt/bitnami/nginx/logs/rentcamallorca_es_error.log;

    location / 
    {
        # reverser proxy
        proxy_pass http://frontend_basico_group;
        proxy_redirect off;

        #ssl
        proxy_ssl_certificate      bitnami/certs/server_local.crt;
        proxy_ssl_certificate_key  bitnami/certs/server_local.key;

        proxy_ssl_trusted_certificate bitnami/certs/server_local.crt;
        proxy_ssl_verify       on;
        proxy_ssl_verify_depth 2;
        proxy_ssl_session_reuse on;
        proxy_ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        proxy_ssl_ciphers   HIGH:!aNULL:!MD5;


        proxy_ssl_name $host;
        proxy_ssl_server_name on;
        



        # Cache
        proxy_cache cache_zone;
        
        proxy_cache_valid 200 302 301 1d;
        proxy_cache_methods GET HEAD;
        proxy_cache_lock on;

        proxy_cache_bypass   $http_secret_header;

        proxy_http_version 1.1;
        add_header X-Cache-Status $upstream_cache_status;

        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-NginX-Proxy true;
        proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Ssl on;
        # proxy_ignore_headers "Set-Cookie";

        # return 301 https://$host$request_uri;
        # return 301 proxy_pass https://frontend_group;

    }

    location /rent
    {
        # reverser proxy
        proxy_pass http://frontend_group/rent;
        proxy_redirect off;

        # Cache
        proxy_cache cache_zone;
        
        proxy_cache_valid 200 302 301 1d;
        proxy_cache_methods GET HEAD;
        proxy_cache_lock on;

        proxy_cache_bypass   $http_secret_header;

        proxy_http_version 1.1;
        add_header X-Cache-Status $upstream_cache_status;

        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-NginX-Proxy true;
        proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;

        # proxy_ignore_headers "Set-Cookie";

    }

    # dashboard en backoffice
    location ~ /dashboard
    {

        proxy_http_version 1.1;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header HOST $http_host;
        proxy_set_header X-NginX-Proxy true;

        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
        
        proxy_pass http://backoffice_group;
        
        # proxy_set_header Host $host:$server_port;
    
        

        proxy_temp_file_write_size 64k;
        proxy_buffer_size 64k;
        proxy_buffers 16 32k;
        proxy_busy_buffers_size 64k;
        
        proxy_set_header Host $server_name;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_request_buffering off;
        proxy_buffering off;
        proxy_redirect off;
        
    }

    # login backoffice
    location ~ /0_QJFs2NH9a_f_a_BQ_NTib_Y3O6Ik_DkWIiW_mFtZSI
    {

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header HOST $http_host;
        proxy_set_header X-NginX-Proxy true;

        proxy_pass http://backoffice_group;

        proxy_redirect off;
    }

    # login backoffice
    location /0_QJFs2NH9a_f_a_BQ_NTib_Y3O6Ik_DkWIiW_mFtZSI/dashboard
    {

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forward-Proto http;
        proxy_set_header X-Nginx-Proxy true;
        proxy_temp_file_write_size 64k;
        proxy_connect_timeout 10080s;
        proxy_send_timeout 10080;
        proxy_read_timeout 10080;
        proxy_buffer_size 64k;
        proxy_buffers 16 32k;
        proxy_busy_buffers_size 64k;
        proxy_redirect off;
        proxy_request_buffering off;
        proxy_buffering off;
        proxy_pass http://backoffice_1:3100;
        

        # proxy_pass http://backoffice_group;

        
    }

    location ^~ /.well-known/acme-challenge 
    {
        allow /opt/bitnami/nginx/html;
        alias /var/www/acme;
    }


}


# server {
#     listen      443 ssl;
#     server_name frontend_basico_1;

#     ssl_certificate      bitnami/certs/server.crt;
#     ssl_certificate_key  bitnami/certs/server.key;
#     ssl_client_certificate bitnami/certs/server_local.crt;
#     ssl_verify_client      optional;

#     location / {
#         proxy_pass http://frontend_basico_1:443;
#     }
# }